{% extends "base.html" %}

{% block title %}Reportes de Ofertas - Sistema de Reclutamiento{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-pie me-2"></i>Reportes de Ofertas</h2>
    <a href="{{ url_for('ofertas') }}" class="btn btn-primary">
        <i class="fas fa-arrow-left me-1"></i>Volver a Ofertas
    </a>
</div>

<!-- Filtros de Reportes -->
<div class="card shadow mb-4">
    <div class="card-header bg-primary text-white">
        <h6 class="mb-0">Filtros del Reporte</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label for="fechaInicio" class="form-label">Fecha Inicio</label>
                <input type="date" class="form-control" id="fechaInicio">
            </div>
            <div class="col-md-3">
                <label for="fechaFin" class="form-label">Fecha Fin</label>
                <input type="date" class="form-control" id="fechaFin">
            </div>
            <div class="col-md-3">
                <label for="estadoReporte" class="form-label">Estado</label>
                <select class="form-control" id="estadoReporte">
                    <option value="">Todos los estados</option>
                    <option value="1">Pendientes</option>
                    <option value="2">Aceptadas</option>
                    <option value="3">Rechazadas</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-success w-100" onclick="generarReportes()">
                    <i class="fas fa-sync-alt me-1"></i>Generar Reporte
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Gráfico de Distribución por Estado -->
    <div class="col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Distribución por Estado</h6>
            </div>
            <div class="card-body">
                <div id="graficoEstados" style="height: 300px;">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 text-muted">Cargando gráfico...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tendencias Mensuales -->
    <div class="col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Tendencias Mensuales</h6>
            </div>
            <div class="card-body">
                <div id="graficoMensual" style="height: 300px;">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 text-muted">Cargando gráfico...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Métricas Clave -->
    <div class="col-md-4">
        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">Métricas Clave</h6>
            </div>
            <div class="card-body">
                <div id="metricasClave">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 text-muted">Cargando métricas...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Vacantes -->
    <div class="col-md-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">Ofertas por Vacante</h6>
            </div>
            <div class="card-body">
                <div id="tablaVacantes">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 text-muted">Cargando datos...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reporte Detallado -->
<div class="card shadow">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">Reporte Detallado</h6>
        <button class="btn btn-outline-info btn-sm" onclick="exportarReporte()">
            <i class="fas fa-download me-1"></i>Exportar PDF
        </button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="tablaReporte">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Candidato</th>
                        <th>Vacante</th>
                        <th>Monto</th>
                        <th>Estado</th>
                        <th>Fecha Emisión</th>
                        <th>Fecha Decisión</th>
                        <th>Días Pendiente</th>
                    </tr>
                </thead>
                <tbody id="cuerpoReporte">
                    <!-- Los datos se cargarán via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Variables globales para los gráficos
let chartEstados = null;
let chartMensual = null;

// Cargar reportes al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    generarReportes();
});

function generarReportes() {
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    const estado = document.getElementById('estadoReporte').value;

    // En un sistema real, aquí harías llamadas API con los filtros
    // Por simplicidad, usaremos datos de ejemplo
    cargarGraficoEstados();
    cargarGraficoMensual();
    cargarMetricasClave();
    cargarTablaVacantes();
    cargarReporteDetallado();
}

function cargarGraficoEstados() {
    const ctx = document.getElementById('graficoEstados').getContext('2d');
    
    // Destruir gráfico anterior si existe
    if (chartEstados) {
        chartEstados.destroy();
    }

    // Datos de ejemplo - en un sistema real estos vendrían de una API
    const data = {
        labels: ['Pendientes', 'Aceptadas', 'Rechazadas'],
        datasets: [{
            data: [45, 30, 25],
            backgroundColor: [
                '#ffc107',
                '#198754', 
                '#dc3545'
            ],
            borderWidth: 1
        }]
    };

    chartEstados = new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Distribución de Ofertas por Estado'
                }
            }
        }
    });
}

function cargarGraficoMensual() {
    const ctx = document.getElementById('graficoMensual').getContext('2d');
    
    // Destruir gráfico anterior si existe
    if (chartMensual) {
        chartMensual.destroy();
    }

    // Datos de ejemplo
    const data = {
        labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
        datasets: [
            {
                label: 'Ofertas Emitidas',
                data: [12, 19, 15, 8, 12, 15, 18, 14, 16, 20, 22, 25],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                fill: true,
                tension: 0.4
            },
            {
                label: 'Ofertas Aceptadas',
                data: [8, 12, 10, 6, 9, 11, 14, 10, 12, 15, 18, 20],
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                fill: true,
                tension: 0.4
            }
        ]
    };

    chartMensual = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Tendencia Mensual de Ofertas'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Cantidad de Ofertas'
                    }
                }
            }
        }
    });
}

function cargarMetricasClave() {
    // Datos de ejemplo
    const html = `
        <div class="text-center">
            <div class="mb-3">
                <h4 class="text-success">68.2%</h4>
                <small class="text-muted">Tasa de Aceptación</small>
            </div>
            <div class="row text-center mb-3">
                <div class="col-6">
                    <h6 class="text-primary">15.2</h6>
                    <small>Días promedio</small>
                </div>
                <div class="col-6">
                    <h6 class="text-warning">$4,250</h6>
                    <small>Monto promedio</small>
                </div>
            </div>
            <hr>
            <div class="mt-3">
                <small class="text-muted">
                    <i class="fas fa-arrow-up text-success me-1"></i>
                    <strong>+12%</strong> vs mes anterior
                </small>
            </div>
        </div>
    `;
    document.getElementById('metricasClave').innerHTML = html;
}

function cargarTablaVacantes() {
    // Datos de ejemplo
    const html = `
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>Vacante</th>
                        <th>Total Ofertas</th>
                        <th>Aceptadas</th>
                        <th>Tasa Éxito</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Desarrollador Frontend</td>
                        <td>15</td>
                        <td>12</td>
                        <td><span class="badge bg-success">80%</span></td>
                    </tr>
                    <tr>
                        <td>Analista de Datos</td>
                        <td>10</td>
                        <td>7</td>
                        <td><span class="badge bg-success">70%</span></td>
                    </tr>
                    <tr>
                        <td>Gerente de Proyecto</td>
                        <td>8</td>
                        <td>5</td>
                        <td><span class="badge bg-warning">62.5%</span></td>
                    </tr>
                    <tr>
                        <td>Especialista DevOps</td>
                        <td>6</td>
                        <td>4</td>
                        <td><span class="badge bg-warning">66.7%</span></td>
                    </tr>
                    <tr>
                        <td>Diseñador UX/UI</td>
                        <td>5</td>
                        <td>3</td>
                        <td><span class="badge bg-warning">60%</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;
    document.getElementById('tablaVacantes').innerHTML = html;
}

function cargarReporteDetallado() {
    // Datos de ejemplo - en un sistema real esto vendría de una API
    const ofertas = [
        { id: 101, candidato: "Ana García", vacante: "Desarrollador Frontend", monto: 4500, estado: "Aceptada", fecha_emision: "2024-01-15", fecha_decision: "2024-01-20", dias: 5 },
        { id: 102, candidato: "Carlos López", vacante: "Analista de Datos", monto: 3800, estado: "Pendiente", fecha_emision: "2024-01-18", fecha_decision: null, dias: 7 },
        { id: 103, candidato: "María Rodríguez", vacante: "Gerente de Proyecto", monto: 5200, estado: "Rechazada", fecha_emision: "2024-01-10", fecha_decision: "2024-01-12", dias: 2 },
        { id: 104, candidato: "Juan Martínez", vacante: "Especialista DevOps", monto: 4800, estado: "Aceptada", fecha_emision: "2024-01-20", fecha_decision: "2024-01-25", dias: 5 },
        { id: 105, candidato: "Laura Fernández", vacante: "Diseñador UX/UI", monto: 3500, estado: "Pendiente", fecha_emision: "2024-01-22", fecha_decision: null, dias: 3 }
    ];

    let html = '';
    ofertas.forEach(oferta => {
        const badgeClass = oferta.estado === 'Aceptada' ? 'bg-success' : 
                          oferta.estado === 'Rechazada' ? 'bg-danger' : 'bg-warning';
        
        html += `
            <tr>
                <td>${oferta.id}</td>
                <td>${oferta.candidato}</td>
                <td>${oferta.vacante}</td>
                <td>$${oferta.monto.toLocaleString('es-ES', {minimumFractionDigits: 2})}</td>
                <td><span class="badge ${badgeClass}">${oferta.estado}</span></td>
                <td>${new Date(oferta.fecha_emision).toLocaleDateString('es-ES')}</td>
                <td>${oferta.fecha_decision ? new Date(oferta.fecha_decision).toLocaleDateString('es-ES') : 'Pendiente'}</td>
                <td>${oferta.dias}</td>
            </tr>
        `;
    });

    document.getElementById('cuerpoReporte').innerHTML = html;
}

function exportarReporte() {
    alert('Funcionalidad de exportación PDF en desarrollo');
    // En un sistema real, aquí se generaría un PDF con los reportes
}

// Establecer fechas por defecto (último mes)
document.addEventListener('DOMContentLoaded', function() {
    const hoy = new Date();
    const haceUnMes = new Date();
    haceUnMes.setMonth(hoy.getMonth() - 1);
    
    document.getElementById('fechaInicio').value = haceUnMes.toISOString().split('T')[0];
    document.getElementById('fechaFin').value = hoy.toISOString().split('T')[0];
});
</script>

<style>
.card {
    border: none;
    border-radius: 0.5rem;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.075);
}

.badge {
    font-size: 0.75em;
}

.card-header {
    border-bottom: 1px solid #e3e6f0;
}
</style>
{% endblock %}