{% extends "base.html" %}

{% block title %}Reportes de Ofertas - Sistema de Reclutamiento{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-file-contract me-2"></i>Reportes de Ofertas</h2>
    <button class="btn btn-outline-primary" onclick="actualizarReportes()">
        <i class="fas fa-sync-alt me-1"></i>Actualizar Reportes
    </button>
</div>

<!-- Filtros del Reporte -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-filter mr-1"></i>
        Filtros del Reporte
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label for="fecha_inicio">Fecha Inicio</label>
                <input type="date" class="form-control" id="fecha_inicio" value="{{ fecha_inicio }}">
            </div>
            <div class="col-md-3">
                <label for="fecha_fin">Fecha Fin</label>
                <input type="date" class="form-control" id="fecha_fin" value="{{ fecha_fin }}">
            </div>
            <div class="col-md-3">
                <label for="estado">Estado</label>
                <select class="form-control" id="estado">
                    <option value="todos">Todos los estados</option>
                    <option value="1">Emitida</option>
                    <option value="2">Aceptada</option>
                    <option value="3">Rechazada</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button id="btn-filtrar" class="btn btn-primary">Filtrar</button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Distribución por Estado -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-chart-pie me-2"></i>Distribución por Estado
                </h6>
            </div>
            <div class="card-body">
                <div id="chart-distribucion">Cargando gráfico...</div>
            </div>
        </div>
    </div>

    <!-- Tendencias Mensuales -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-chart-line me-2"></i>Tendencias Mensuales
                </h6>
            </div>
            <div class="card-body">
                <div id="chart-tendencias">Cargando gráfico...</div>
            </div>
        </div>
    </div>

    <!-- Métricas Clave -->
    <div class="col-lg-12 mb-4">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-key me-2"></i>Métricas Clave
                </h6>
            </div>
            <div class="card-body">
                <div id="metricas-clave">Cargando métricas...</div>
            </div>
        </div>
    </div>

    <!-- Ofertas por Vacante -->
    <div class="col-lg-12 mb-4">
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-briefcase me-2"></i>Ofertas por Vacante
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="tabla-vacantes" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Vacante</th>
                                <th>Total Ofertas</th>
                                <th>Aceptadas</th>
                                <th>Rechazadas</th>
                                <th>Monto Promedio</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center">Cargando datos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Reporte Detallado -->
    <div class="col-lg-12 mb-4">
        <div class="card shadow">
            <div class="card-header bg-secondary text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-table me-2"></i>Reporte Detallado
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="tabla-detallada" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Candidato</th>
                                <th>Vacante</th>
                                <th>Monto</th>
                                <th>Estado</th>
                                <th>Fecha Emisión</th>
                                <th>Fecha Decisión</th>
                                <th>Días Pendiente</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" class="text-center">Cargando datos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Highcharts -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>

<script>
// Función para cargar distribución por estado
function cargarDistribucionEstado() {
    fetch('/api/reportes/ofertas/distribucion-estado')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Highcharts.chart('chart-distribucion', {
                    chart: {
                        plotBackgroundColor: null,
                        plotBorderWidth: null,
                        plotShadow: false,
                        type: 'pie'
                    },
                    title: {
                        text: 'Distribución de Ofertas por Estado'
                    },
                    tooltip: {
                        pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                    },
                    accessibility: {
                        point: {
                            valueSuffix: '%'
                        }
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '<b>{point.name}</b>: {point.percentage:.1f} %'
                            },
                            showInLegend: true
                        }
                    },
                    series: [{
                        name: 'Estados',
                        colorByPoint: true,
                        data: data.datos.map(item => ({
                            name: item.nom_estado,
                            y: item.cantidad
                        }))
                    }]
                });
            }
        })
        .catch(error => console.error('Error:', error));
}

// Función para cargar tendencias mensuales
function cargarTendenciasMensuales() {
    fetch('/api/reportes/ofertas/tendencias-mensuales')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Highcharts.chart('chart-tendencias', {
                    chart: {
                        type: 'column'
                    },
                    title: {
                        text: 'Tendencias Mensuales de Ofertas'
                    },
                    xAxis: {
                        categories: data.datos.map(item => item.mes),
                        crosshair: true
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: 'Cantidad de Ofertas'
                        }
                    },
                    tooltip: {
                        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                            '<td style="padding:0"><b>{point.y}</b></td></tr>',
                        footerFormat: '</table>',
                        shared: true,
                        useHTML: true
                    },
                    plotOptions: {
                        column: {
                            pointPadding: 0.2,
                            borderWidth: 0
                        }
                    },
                    series: [{
                        name: 'Total',
                        data: data.datos.map(item => item.cantidad),
                        color: '#3498db'
                    }, {
                        name: 'Aceptadas',
                        data: data.datos.map(item => item.aceptadas),
                        color: '#2ecc71'
                    }, {
                        name: 'Rechazadas',
                        data: data.datos.map(item => item.rechazadas),
                        color: '#e74c3c'
                    }]
                });
            }
        })
        .catch(error => console.error('Error:', error));
}

// Función para cargar métricas clave
function cargarMetricasClave() {
    fetch('/api/reportes/ofertas/metricas-clave')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const metricas = data.datos;
                document.getElementById('metricas-clave').innerHTML = `
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4>${metricas.total_ofertas}</h4>
                                    <p class="mb-0">Total de Ofertas</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4>${metricas.tasa_aceptacion}%</h4>
                                    <p class="mb-0">Tasa de Aceptación</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4>$${metricas.monto_promedio.toFixed(2)}</h4>
                                    <p class="mb-0">Monto Promedio</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h4>${metricas.tiempo_promedio_decision.toFixed(1)} días</h4>
                                    <p class="mb-0">Tiempo Promedio de Decisión</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => console.error('Error:', error));
}

// Función para cargar ofertas por vacante
function cargarOfertasPorVacante() {
    fetch('/api/reportes/ofertas/por-vacante')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const tabla = document.getElementById('tabla-vacantes');
                const tbody = tabla.querySelector('tbody');
                
                // Limpiar tabla
                tbody.innerHTML = '';
                
                // Llenar tabla con datos
                data.datos.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.titulo_vacante}</td>
                        <td>${item.total_ofertas}</td>
                        <td>${item.aceptadas}</td>
                        <td>${item.rechazadas}</td>
                        <td>$${parseFloat(item.monto_promedio || 0).toFixed(2)}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        })
        .catch(error => console.error('Error:', error));
}

// Función para cargar reporte detallado
function cargarReporteDetallado() {
    const fechaInicio = document.getElementById('fecha_inicio').value;
    const fechaFin = document.getElementById('fecha_fin').value;
    const estado = document.getElementById('estado').value;
    
    let url = '/api/reportes/ofertas/detallado?';
    if (fechaInicio) url += `fecha_inicio=${fechaInicio}&`;
    if (fechaFin) url += `fecha_fin=${fechaFin}&`;
    if (estado) url += `estado=${estado}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const tabla = document.getElementById('tabla-detallada');
                const tbody = tabla.querySelector('tbody');
                
                // Limpiar tabla
                tbody.innerHTML = '';
                
                // Llenar tabla con datos
                data.datos.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.id_oferta}</td>
                        <td>${item.nom_candidato}</td>
                        <td>${item.titulo_vacante}</td>
                        <td>$${parseFloat(item.monto_oferta).toFixed(2)}</td>
                        <td>${item.nom_estado}</td>
                        <td>${item.fecha_emision_estimada || 'N/A'}</td>
                        <td>${item.fecha_decision || 'N/A'}</td>
                        <td>${item.dias_pendiente || 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        })
        .catch(error => console.error('Error:', error));
}

// Función para actualizar todos los reportes
function actualizarReportes() {
    cargarDistribucionEstado();
    cargarTendenciasMensuales();
    cargarMetricasClave();
    cargarOfertasPorVacante();
    cargarReporteDetallado();
    
    // Mostrar mensaje de actualización
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
    alert.style.zIndex = '1060';
    alert.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>Reportes actualizados correctamente
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    // Auto-remover después de 3 segundos
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 3000);
}

// Cargar todos los reportes cuando la página esté lista
document.addEventListener('DOMContentLoaded', function() {
    actualizarReportes();
    
    // Event listener para filtros
    document.getElementById('btn-filtrar').addEventListener('click', function() {
        cargarReporteDetallado();
    });
    
    // Actualizar automáticamente cada 5 minutos
    setInterval(actualizarReportes, 300000);
});
</script>

<style>
.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}

.highcharts-container {
    border-radius: 0.375rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .card-body {
        padding: 1rem;
    }
}
</style>
{% endblock %}