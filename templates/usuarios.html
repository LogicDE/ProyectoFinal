{% extends "base.html" %}

{% block title %}Gestión de Usuarios - Sistema de Reclutamiento{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-users me-2"></i>Gestión de Usuarios del Sistema</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalUsuario" onclick="limpiarFormulario()">
        <i class="fas fa-plus me-1"></i>Nuevo Usuario
    </button>
</div>

<!-- Filtros y Búsqueda -->
<div class="card shadow mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Buscar usuarios..." id="busquedaUsuarios">
                    <button class="btn btn-outline-secondary" type="button" onclick="filtrarUsuarios()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-control" id="filtroRol">
                    <option value="">Todos los roles</option>
                    {% for rol in roles %}
                    <option value="{{ rol.id_rolsistema }}">{{ rol.nom_rol }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-control" id="filtroEstado">
                    <option value="">Todos los estados</option>
                    <option value="1">Activos</option>
                    <option value="0">Inactivos</option>
                </select>
            </div>
            <div class="col-md-2 text-end">
                <div class="btn-group">
                    <button class="btn btn-outline-info" onclick="exportarUsuarios()">
                        <i class="fas fa-download me-1"></i>Exportar
                    </button>
                    <button class="btn btn-outline-secondary" onclick="recargarTabla()">
                        <i class="fas fa-sync-alt me-1"></i>Actualizar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de Usuarios -->
<div class="card shadow">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">Lista de Usuarios del Sistema</h6>
        <span class="badge bg-primary">{{ usuarios|length }} usuarios</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="tablaUsuarios">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Usuario</th>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>Tipo</th>
                        <th>Fecha Creación</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for usuario in usuarios %}
                    <tr data-usuario-id="{{ usuario.id_usuario }}" data-rol-id="{{ usuario.id_rolsistema }}" data-estado="{{ usuario.activo }}">
                        <td>{{ usuario.id_usuario }}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-circle bg-primary text-white me-2">
                                    {{ usuario.username[0]|upper }}
                                </div>
                                <div>
                                    <strong>{{ usuario.username }}</strong>
                                    {% if usuario.id_usuario == session.id_usuario %}
                                    <span class="badge bg-info ms-1">Tú</span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>{{ usuario.email }}</td>
                        <td>
                            <span class="badge bg-{{ 
                                'danger' if usuario.id_rolsistema == 1 else 
                                'warning' if usuario.id_rolsistema == 2 else 
                                'success' if usuario.id_rolsistema == 9 else 
                                'info' 
                            }}">
                                {{ usuario.nom_rol }}
                            </span>
                        </td>
                        <td>
                            <small class="text-muted">{{ usuario.tipo_usuario }}</small>
                        </td>
                        <td>{{ usuario.creado_en }}</td>
                        <td>
                            {% if usuario.activo %}
                            <span class="badge bg-success">Activo</span>
                            {% else %}
                            <span class="badge bg-danger">Inactivo</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                {% if usuario.id_usuario != session.id_usuario %}
                                    {% if usuario.activo %}
                                    <button class="btn btn-outline-warning" 
                                            onclick="editarUsuario({{ usuario.id_usuario }})"
                                            data-bs-toggle="tooltip" title="Editar usuario">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" 
                                            onclick="confirmarDesactivacion({{ usuario.id_usuario }}, '{{ usuario.username }}')"
                                            data-bs-toggle="tooltip" title="Desactivar usuario">
                                        <i class="fas fa-user-slash"></i>
                                    </button>
                                    {% else %}
                                    <button class="btn btn-outline-success" 
                                            onclick="reactivarUsuario({{ usuario.id_usuario }})"
                                            data-bs-toggle="tooltip" title="Reactivar usuario">
                                        <i class="fas fa-user-check"></i>
                                    </button>
                                    {% endif %}
                                {% else %}
                                    <button class="btn btn-outline-primary" 
                                            onclick="window.location.href='{{ url_for('mi_perfil') }}'"
                                            data-bs-toggle="tooltip" title="Editar mi perfil">
                                        <i class="fas fa-user-edit"></i>
                                    </button>
                                {% endif %}
                                <button class="btn btn-outline-info" 
                                        onclick="verDetalles({{ usuario.id_usuario }})"
                                        data-bs-toggle="tooltip" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Mensaje si no hay usuarios -->
        {% if not usuarios %}
        <div class="text-center py-4">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No hay usuarios registrados</h5>
            <p class="text-muted">Comienza creando el primer usuario del sistema.</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalUsuario">
                <i class="fas fa-plus me-1"></i>Crear Primer Usuario
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para Nuevo Usuario -->
<div class="modal fade" id="modalUsuario" tabindex="-1" aria-labelledby="modalUsuarioLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalUsuarioLabel">Nuevo Usuario del Sistema</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formUsuario" method="POST" action="{{ url_for('crear_usuario') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">Nombre de Usuario *</label>
                                <input type="text" class="form-control" id="username" name="username" required
                                       placeholder="Ingrese nombre de usuario">
                                <div class="form-text">El nombre de usuario debe ser único.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email" name="email" required
                                       placeholder="usuario@empresa.com">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="password" class="form-label">Contraseña *</label>
                                <input type="password" class="form-control" id="password" name="password" required
                                       placeholder="Ingrese contraseña">
                                <div class="form-text">Mínimo 6 caracteres.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="confirm_password" class="form-label">Confirmar Contraseña *</label>
                                <input type="password" class="form-control" id="confirm_password" name="confirm_password" required
                                       placeholder="Confirme la contraseña">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_rolsistema" class="form-label">Rol del Sistema *</label>
                                <select class="form-control" id="id_rolsistema" name="id_rolsistema" required>
                                    <option value="">Seleccionar rol...</option>
                                    {% for rol in roles %}
                                    <option value="{{ rol.id_rolsistema }}">{{ rol.nom_rol }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_entrevistador" class="form-label">Entrevistador Asociado</label>
                                <select class="form-control" id="id_entrevistador" name="id_entrevistador">
                                    <option value="">Sin entrevistador asociado</option>
                                    {% for entrevistador in entrevistadores %}
                                    <option value="{{ entrevistador.id_entrevistador }}">{{ entrevistador.nom_entrevistador }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Opcional: asociar a un entrevistador existente.</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Crear Usuario
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Confirmación para Desactivar -->
<div class="modal fade" id="modalConfirmarDesactivacion" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Desactivación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="textoDesactivacion">¿Está seguro que desea desactivar este usuario?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Advertencia:</strong> El usuario no podrá acceder al sistema hasta que sea reactivado.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="formDesactivarUsuario" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-user-slash me-1"></i>Desactivar Usuario
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Ver Detalles -->
<div class="modal fade" id="modalDetallesUsuario" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detallesUsuario">
                <!-- Los detalles se cargarán via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Inicializar tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
});

// Función para limpiar el formulario
function limpiarFormulario() {
    document.getElementById('formUsuario').reset();
    document.getElementById('modalUsuarioLabel').textContent = 'Nuevo Usuario del Sistema';
    document.getElementById('formUsuario').action = "{{ url_for('crear_usuario') }}";
}

// Función para editar usuario
function editarUsuario(idUsuario) {
    window.location.href = `/usuarios/editar/${idUsuario}`;
}

// Función para ver detalles del usuario
function verDetalles(idUsuario) {
    fetch(`/api/usuarios/${idUsuario}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const usuario = data.usuario;
                const detallesHTML = `
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="avatar-circle-lg bg-primary text-white mx-auto mb-3">
                                ${usuario.username[0].toUpperCase()}
                            </div>
                            <h5>${usuario.username}</h5>
                            ${usuario.id_usuario == {{ session.id_usuario }} ? '<span class="badge bg-info">Tu usuario</span>' : ''}
                        </div>
                        <div class="col-md-9">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Información Básica</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>ID:</strong> ${usuario.id_usuario}</li>
                                        <li><strong>Email:</strong> ${usuario.email}</li>
                                        <li><strong>Rol:</strong> <span class="badge bg-primary">${usuario.nom_rol}</span></li>
                                        <li><strong>Estado:</strong> ${usuario.activo ? '<span class="badge bg-success">Activo</span>' : '<span class="badge bg-danger">Inactivo</span>'}</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Información Adicional</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Entrevistador:</strong> ${usuario.nom_entrevistador || 'No asociado'}</li>
                                        <li><strong>Fecha Creación:</strong> ${usuario.creado_en}</li>
                                        <li><strong>Último Acceso:</strong> ${usuario.ultimo_acceso || 'No registrado'}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6>Permisos del Rol</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Módulo</th>
                                            <th>Permisos</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Candidatos</td>
                                            <td>
                                                <span class="badge bg-${usuario.id_rolsistema == 1 || usuario.id_rolsistema == 2 || usuario.id_rolsistema == 9 ? 'success' : 'secondary'}">Ver</span>
                                                <span class="badge bg-${usuario.id_rolsistema == 1 || usuario.id_rolsistema == 2 || usuario.id_rolsistema == 9 ? 'warning' : 'secondary'}">Editar</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Vacantes</td>
                                            <td>
                                                <span class="badge bg-${usuario.id_rolsistema == 1 || usuario.id_rolsistema == 2 || usuario.id_rolsistema == 9 || usuario.id_rolsistema == 10 ? 'success' : 'secondary'}">Ver</span>
                                                <span class="badge bg-${usuario.id_rolsistema == 1 || usuario.id_rolsistema == 2 || usuario.id_rolsistema == 9 || usuario.id_rolsistema == 10 ? 'warning' : 'secondary'}">Editar</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Usuarios</td>
                                            <td>
                                                <span class="badge bg-${usuario.id_rolsistema == 1 ? 'success' : 'secondary'}">Ver</span>
                                                <span class="badge bg-${usuario.id_rolsistema == 1 ? 'warning' : 'secondary'}">Administrar</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('detallesUsuario').innerHTML = detallesHTML;
                const modal = new bootstrap.Modal(document.getElementById('modalDetallesUsuario'));
                modal.show();
            } else {
                alert('Error al cargar los detalles del usuario');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los detalles del usuario');
        });
}

// Función para confirmar desactivación
function confirmarDesactivacion(idUsuario, username) {
    document.getElementById('textoDesactivacion').textContent = `¿Está seguro que desea desactivar al usuario "${username}"?`;
    document.getElementById('formDesactivarUsuario').action = `/usuarios/eliminar/${idUsuario}`;
    
    const modal = new bootstrap.Modal(document.getElementById('modalConfirmarDesactivacion'));
    modal.show();
}

// Función para reactivar usuario
function reactivarUsuario(idUsuario) {
    if (confirm('¿Está seguro que desea reactivar este usuario?')) {
        fetch(`/usuarios/reactivar/${idUsuario}`, { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Error al reactivar el usuario');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al reactivar el usuario');
            });
    }
}

// Función para filtrar usuarios
function filtrarUsuarios() {
    const busqueda = document.getElementById('busquedaUsuarios').value.toLowerCase();
    const filtroRol = document.getElementById('filtroRol').value;
    const filtroEstado = document.getElementById('filtroEstado').value;
    const filas = document.querySelectorAll('#tablaUsuarios tbody tr');
    
    filas.forEach(fila => {
        const textoFila = fila.textContent.toLowerCase();
        const rolId = fila.getAttribute('data-rol-id');
        const estado = fila.getAttribute('data-estado');
        
        const coincideBusqueda = textoFila.includes(busqueda);
        const coincideRol = !filtroRol || rolId === filtroRol;
        const coincideEstado = !filtroEstado || estado === filtroEstado;
        
        if (coincideBusqueda && coincideRol && coincideEstado) {
            fila.style.display = '';
        } else {
            fila.style.display = 'none';
        }
    });
}

// Función para exportar usuarios
function exportarUsuarios() {
    // En una implementación real, aquí se generaría un CSV o Excel
    alert('Funcionalidad de exportación en desarrollo');
}

// Función para recargar la tabla
function recargarTabla() {
    window.location.reload();
}

// Validación del formulario
document.getElementById('formUsuario').addEventListener('submit', function(e) {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    // Validar que las contraseñas coincidan
    if (password !== confirmPassword) {
        e.preventDefault();
        alert('Las contraseñas no coinciden');
        return;
    }
    
    // Validar longitud mínima de contraseña
    if (password.length < 6) {
        e.preventDefault();
        alert('La contraseña debe tener al menos 6 caracteres');
        return;
    }
});

// Búsqueda en tiempo real
document.getElementById('busquedaUsuarios').addEventListener('input', filtrarUsuarios);

// Filtros en tiempo real
document.getElementById('filtroRol').addEventListener('change', filtrarUsuarios);
document.getElementById('filtroEstado').addEventListener('change', filtrarUsuarios);
</script>

<style>
.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.avatar-circle-lg {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 2rem;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.075);
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.badge {
    font-size: 0.75em;
}

/* Estilos para la tabla responsive */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    .btn-group .btn {
        margin-bottom: 0.25rem;
        border-radius: 0.25rem;
    }
    
    .avatar-circle {
        width: 32px;
        height: 32px;
        font-size: 0.875rem;
    }
}
</style>
{% endblock %}