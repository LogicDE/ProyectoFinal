{% extends "base.html" %}

{% block title %}Editar Entrevista - Sistema de Reclutamiento{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-edit me-2"></i>Editar Entrevista</h2>
    <a href="{{ url_for('entrevistas') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i>Volver a Entrevistas
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Información de la Entrevista</h6>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('editar_entrevista', id=entrevista.id_entrevista) }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Candidato</label>
                                <input type="text" class="form-control" value="{{ entrevista.nom_candidato }}" readonly>
                                <div class="form-text">El candidato no se puede cambiar.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Vacante</label>
                                <input type="text" class="form-control" value="{{ entrevista.titulo_vacante }}" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fecha_entrevista" class="form-label">Fecha *</label>
                                <input type="date" class="form-control" id="fecha_entrevista" name="fecha_entrevista" 
                                       value="{{ entrevista.fecha_sola }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="hora_entrevista" class="form-label">Hora *</label>
                                <input type="time" class="form-control" id="hora_entrevista" name="hora_entrevista" 
                                       value="{{ entrevista.hora_sola }}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_entrevistador" class="form-label">Entrevistador *</label>
                                <select class="form-control" id="id_entrevistador" name="id_entrevistador" required>
                                    {% for entrevistador in entrevistadores %}
                                    <option value="{{ entrevistador.id_entrevistador }}" 
                                            {% if entrevistador.id_entrevistador == entrevista.id_entrevistador %}selected{% endif %}>
                                        {{ entrevistador.nom_entrevistador }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_estadoentrevista" class="form-label">Estado *</label>
                                <select class="form-control" id="id_estadoentrevista" name="id_estadoentrevista" required>
                                    {% for estado in estados_entrevista %}
                                    <option value="{{ estado.id_estadoentrevista }}" 
                                            {% if estado.id_estadoentrevista == entrevista.id_estadoentrevista %}selected{% endif %}>
                                        {{ estado.nom_estado }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notas" class="form-label">Notas Adicionales</label>
                        <textarea class="form-control" id="notas" name="notas" rows="4" 
                                  placeholder="Agregar notas, preguntas preparadas, ubicación, etc.">{{ entrevista.notas or '' }}</textarea>
                    </div>
                    
                    {% if entrevista.puntaje %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Información:</strong> Esta entrevista ya tiene feedback registrado. 
                        El puntaje actual es <strong>{{ entrevista.puntaje }}/100</strong>.
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('entrevistas') }}" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </a>
                        <div>
                            {% if entrevista.id_estadoentrevista in [1, 2] and not entrevista.puntaje %}
                            <a href="{{ url_for('registrar_feedback_entrevista', id=entrevista.id_entrevista) }}" class="btn btn-success me-2">
                                <i class="fas fa-clipboard-check me-1"></i>Registrar Feedback
                            </a>
                            {% endif %}
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Guardar Cambios
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Información de la Entrevista -->
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Detalles de la Entrevista</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>ID de Entrevista:</strong><br>
                    <code>{{ entrevista.id_entrevista }}</code>
                </div>
                <div class="mb-3">
                    <strong>Postulación:</strong><br>
                    {{ entrevista.nom_candidato }} - {{ entrevista.titulo_vacante }}
                </div>
                <div class="mb-3">
                    <strong>Fecha Original:</strong><br>
                    {% if entrevista.fecha_entrevista %}
    {% if entrevista.fecha_entrevista is string %}
        {{ entrevista.fecha_entrevista }}
    {% else %}
        {{ entrevista.fecha_entrevista.strftime('%d/%m/%Y %H:%M') }}
    {% endif %}
{% else %}
    No definida
{% endif %}
                </div>
                <div class="mb-3">
                    <strong>Estado Actual:</strong><br>
                    <span class="badge bg-{{ 
                        'success' if entrevista.id_estadoentrevista == 1 else 
                        'warning' if entrevista.id_estadoentrevista == 2 else 
                        'info' if entrevista.id_estadoentrevista == 3 else 
                        'secondary' 
                    }}">
                        {{ entrevista.estado_entrevista }}
                    </span>
                </div>
                {% if entrevista.puntaje %}
                <div class="mb-3">
                    <strong>Puntaje:</strong><br>
                    <span class="badge bg-{{ 
                        'danger' if entrevista.puntaje < 60 else 
                        'warning' if entrevista.puntaje < 80 else 
                        'success' 
                    }}">
                        {{ entrevista.puntaje }}/100
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Acciones Rápidas -->
        <div class="card shadow mt-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Acciones Rápidas</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('calendario') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-calendar me-1"></i>Ver en Calendario
                    </a>
                    
                    {% if entrevista.id_estadoentrevista in [1, 2] and not entrevista.puntaje %}
                    <a href="{{ url_for('registrar_feedback_entrevista', id=entrevista.id_entrevista) }}" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-clipboard-check me-1"></i>Registrar Feedback
                    </a>
                    {% endif %}
                    
                    {% if entrevista.puntaje %}
                    <button class="btn btn-outline-info btn-sm" onclick="verDetalles({{ entrevista.id_entrevista }})">
                        <i class="fas fa-eye me-1"></i>Ver Feedback
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Validación del formulario
document.querySelector('form').addEventListener('submit', function(e) {
    const fechaEntrevista = document.getElementById('fecha_entrevista').value;
    const horaEntrevista = document.getElementById('hora_entrevista').value;
    
    // Validar que se hayan proporcionado fecha y hora
    if (!fechaEntrevista || !horaEntrevista) {
        e.preventDefault();
        alert('Por favor, complete la fecha y hora de la entrevista');
        return;
    }
    
    // Validar que la fecha no sea en el pasado (permitir para reprogramación)
    const fechaSeleccionada = new Date(fechaEntrevista + 'T' + horaEntrevista);
    const ahora = new Date();
    
    if (fechaSeleccionada < ahora) {
        if (!confirm('Está programando una entrevista en una fecha/hora pasada. ¿Está seguro?')) {
            e.preventDefault();
        }
    }
});

// Función para ver detalles (se usa desde el botón de feedback)
function verDetalles(idEntrevista) {
    // Esta función se implementaría similar a como está en entrevistas.html
    alert('Funcionalidad de ver detalles en desarrollo');
}
</script>

<style>
.card {
    margin-bottom: 1rem;
}

.btn-group-vertical .btn {
    margin-bottom: 0.5rem;
    text-align: left;
}

.badge {
    font-size: 0.8em;
}
</style>
{% endblock %}